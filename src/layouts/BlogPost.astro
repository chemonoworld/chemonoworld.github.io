---
import type { CollectionEntry } from "astro:content";
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

import type { MarkdownHeading } from "astro";

type Props = CollectionEntry<"blog">["data"] & {
	headings: MarkdownHeading[];
};

const { title, description, pubDate, updatedDate, heroImage, headings, tags } =
	Astro.props;
---

<html lang="en" class="h-full">
	<head>
		<BaseHead title={title} description={description} />
	</head>

	<body class="h-full flex flex-col bg-white text-gray-900 antialiased">
		<Header />
		<main class="w-full max-w-3xl mx-auto px-4 py-8 relative">
			<article class="prose prose-lg prose-blue w-full">
				<div class="mb-12 text-center">
					<div
						class="text-gray-500 mb-4 text-sm font-medium tracking-wide uppercase"
					>
						<time datetime={pubDate.toISOString()}>
							{
								pubDate.toLocaleDateString("en-us", {
									year: "numeric",
									month: "short",
									day: "numeric",
								})
							}
						</time>
						{
							updatedDate && (
								<span class="ml-2 pl-2 border-l border-gray-300 italic normal-case tracking-normal text-gray-400">
									Updated:{" "}
									<time datetime={updatedDate.toISOString()}>
										{updatedDate.toLocaleDateString(
											"en-us",
											{
												year: "numeric",
												month: "short",
												day: "numeric",
											},
										)}
									</time>
								</span>
							)
						}
					</div>
					<h1
						class="text-4xl font-extrabold tracking-tight text-gray-900 sm:text-5xl mb-6 leading-tight"
					>
						{title}
					</h1>
					{
						tags && (
							<div class="flex flex-wrap justify-center gap-2 mb-8">
								{tags.map((tag: string) => (
									<span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs font-medium hover:bg-gray-200 transition-colors cursor-default">
										#{tag}
									</span>
								))}
							</div>
						)
					}
					{
						heroImage && (
							<img
								width={1020}
								height={510}
								src={heroImage}
								alt=""
								class="rounded-xl shadow-lg w-full object-cover aspect-[2/1]"
							/>
						)
					}
				</div>
				<slot />
			</article>
			<aside
				class="hidden xl:block absolute left-full top-0 ml-16 h-full"
			>
				<div class="sticky top-24 w-64">
					<h2
						class="font-bold text-gray-900 mb-4 text-xs uppercase tracking-wider text-gray-400"
					>
						On This Page
					</h2>
					<ul
						class="space-y-3 text-sm border-l border-gray-200"
						id="toc"
					>
						{
							headings.map((heading) => (
								<li
									class={`
                                ${heading.depth === 1 ? "pl-4 text-sm font-semibold text-gray-900" : ""}
                                ${heading.depth === 2 ? "pl-6 text-sm" : ""}
                                ${heading.depth === 3 ? "pl-10 text-xs" : ""}
                                ${heading.depth > 3 ? "pl-12 text-xs" : ""}
                            `}
								>
									<a
										href={`#${heading.slug}`}
										class={`block transition-colors duration-200 leading-snug toc-link
                                            ${heading.depth <= 2 ? "text-gray-600 hover:text-gray-900" : "text-gray-500 hover:text-gray-800"}
                                        `}
										data-slug={heading.slug}
									>
										{heading.text}
									</a>
								</li>
							))
						}
					</ul>
				</div>
			</aside>
		</main>
		<Footer />
		<script>
			// ScrollSpy Implementation
			document.addEventListener("astro:page-load", () => {
				const observer = new IntersectionObserver(
					(entries) => {
						entries.forEach((entry) => {
							const id = entry.target.getAttribute("id");
							const link = document.querySelector(
								`.toc-link[data-slug="${id}"]`,
							);

							if (entry.isIntersecting) {
								// Remove active from all
								document
									.querySelectorAll(".toc-link")
									.forEach((l) => {
										l.classList.remove(
											"text-blue-600",
											"font-medium",
											"border-l-2",
											"border-blue-600",
											"-ml-[2px]",
										);
										l.classList.add(
											"text-gray-600",
											"text-gray-500",
										); // Reset to default based on depth (simplified)
										// Restoring original depth-based styling is hard purely with classList,
										// so we'll rely on the base classes and just add/remove the 'active' overrides.
									});

								if (link) {
									link.classList.remove(
										"text-gray-600",
										"text-gray-500",
									);
									link.classList.add(
										"text-blue-600",
										"font-medium",
									);
									// Highlight the parent border or the link itself
									// Since the border is on the UL, we might want to simulate a border on the link or LI
									// Let's try adding a border to the LI or styling the link to look like it has a border
								}
							}
						});
					},
					{
						rootMargin: "-100px 0px -66% 0px", // Trigger when element is near top
					},
				);

				// Track all headings
				document
					.querySelectorAll("h1, h2, h3, h4")
					.forEach((heading) => {
						observer.observe(heading);
					});
			});

			// Handle initial load matching strictly for regular script execution if view transitions aren't used,
			// but assuming Astro. logic above handles view transitions.
			// Fallback for non-view-transition loads:
			window.addEventListener("scroll", () => {
				const headings = Array.from(
					document.querySelectorAll(
						"article h1, article h2, article h3",
					),
				);
				const scrollY = window.scrollY;

				// Find the current heading
				let current = "";
				for (const heading of headings) {
					if ((heading as HTMLElement).offsetTop - 150 <= scrollY) {
						current = heading.getAttribute("id") || "";
					}
				}

				document.querySelectorAll(".toc-link").forEach((link) => {
					link.classList.remove("text-blue-600", "font-medium");
					if (link.getAttribute("href") === `#${current}`) {
						link.classList.add("text-blue-600", "font-medium");
					}
				});
			});
		</script>
	</body>
</html>
